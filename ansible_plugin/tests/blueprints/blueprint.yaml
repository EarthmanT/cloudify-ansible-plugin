tosca_definitions_version: cloudify_dsl_1_0

imports:
  - http://www.getcloudify.org/spec/cloudify/3.3m2/types.yaml
  - http://www.getcloudify.org/spec/openstack-plugin/1.3m2/plugin.yaml
  - https://raw.githubusercontent.com/EarthmanT/cloudify-ansible-plugin/master/plugin.yaml

inputs:

  image:
    type: string

  flavor:
    type: string

  playbook_file:
    type: string

node_types:

  ansible.nodes.Application:
    derived_from: cloudify.nodes.ApplicationModule
    interfaces:
      cloudify.interfaces.lifecycle:
        configure:
          implementation: ansible.ansible_plugin.tasks.configure
          inputs: {}
        start:
          implementation: ansible.ansible_plugin.tasks.ansible_playbook
          inputs: {}

node_templates:

  ansible_http_server:
    type: cloudify.openstack.nodes.Server
    properties:
      server:
        image: { get_input: image }
        flavor: { get_input: flavor }
    relationships:
      - type: cloudify.openstack.server_connected_to_security_group
        target: ansible_security_group
      - type: cloudify.openstack.server_connected_to_floating_ip
        target: ansible_floating_ip

  apache_instance:
    type: ansible.nodes.Application
    interfaces:
      cloudify.interfaces.lifecycle:
        configure:
          implementation: ansible.ansible_plugin.tasks.configure
        start:
          implementation: ansible.ansible_plugin.tasks.ansible_playbook
          inputs:
            playbook: { get_input: playbook_file }
            private_ip_address: { get_attribute: [ ansible_http_server, ip ] }
    relationships:
      - type: cloudify.relationships.contained_in
        target: ansible_http_server

  ansible_floating_ip:
    type: cloudify.openstack.nodes.FloatingIP

  ansible_security_group:
    type: cloudify.openstack.nodes.SecurityGroup
    properties:
      security_group:
        name: ansible_security_group
      rules:
        - remote_ip_prefix: 0.0.0.0/0
          port: 80
