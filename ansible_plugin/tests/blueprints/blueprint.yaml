tosca_definitions_version: cloudify_dsl_1_0

imports:
  - http://www.getcloudify.org/spec/cloudify/3.2/types.yaml
  - http://www.getcloudify.org/spec/aws-plugin/1.2/plugin.yaml
  - https://raw.githubusercontent.com/EarthmanT/cloudify-ansible-plugin/master/plugin.yaml

inputs:

  image:
    type: string

  flavor:
    type: string

  playbook_file:
    type: string

  agent_user:
    default: ubuntu

node_types:

  ansible.nodes.Application:
    derived_from: cloudify.nodes.ApplicationModule
    interfaces:
      cloudify.interfaces.lifecycle:
        configure:
          implementation: ansible.ansible_plugin.tasks.configure
          inputs:
            user:
              default: {}
            key:
              default: {}
        start:
          implementation: ansible.ansible_plugin.tasks.ansible_playbook
          inputs:
            playbooks:
              default: {}

node_templates:

  host:
    type: cloudify.aws.nodes.Instance
    properties:
      cloudify_agent:
        user: { get_input: agent_user }
      image_id: { get_input: image }
      instance_type: { get_input: flavor }

  apache_instance:
    type: ansible.nodes.Application
    interfaces:
      cloudify.interfaces.lifecycle:
        configure:
          implementation: ansible.ansible_plugin.tasks.configure
          inputs:
            user: { get_property: [ host, cloudify_agent, user ] }
        start:
          implementation: ansible.ansible_plugin.tasks.ansible_playbook
          inputs:
            playbooks:
              - { get_input: playbook_file }
    relationships:
      - type: cloudify.relationships.contained_in
        target: host

